---
title: "混合搜索原理"
weight: 12
bookToc: true
---

# 混合搜索的工作原理

## 处理管线

运行 `qmd query` 时，搜索经过复杂的管线：

1. **查询扩展** — AI 生成替代表述
2. **并行检索** — 每种表述同时搜索关键词和向量索引
3. **RRF 融合** — 使用数学公式合并结果
4. **LLM 重排序** — AI 判断每个结果的相关性
5. **位置感知混合** — 最终分数结合检索和重排序

## 第 1 步：查询扩展

你的原始查询由本地 AI 模型生成替代表述。原始查询获得**双倍权重**。

## 第 2 步：并行检索

每个查询变体在两个索引中搜索（BM25 + 向量）= 6 个结果列表。

## 第 3 步：Reciprocal Rank Fusion（RRF）

```
score = Σ(1 / (k + rank + 1))    其中 k = 60
```

出现在多个列表中的文档获得更高分数。排名奖励：第1名 → +0.05，第2-3名 → +0.02。

## 第 4 步：LLM 重排序

前 30 个候选由 Qwen3 Reranker 模型评分（0 到 10 分）。

## 第 5 步：位置感知混合

| RRF 排名 | 检索权重 | 重排序权重 |
|----------|---------|-----------|
| 1–3 | 75% | 25% |
| 4–10 | 60% | 40% |
| 11+ | 40% | 60% |

顶部结果通常包含精确匹配，需要保留。较低排名的结果更受益于 AI 的判断。

## 下一步

探索 MCP HTTP 服务器，实现共享的持久访问。
