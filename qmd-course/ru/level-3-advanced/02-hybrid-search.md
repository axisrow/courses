---
title: "Как работает гибридный поиск"
weight: 12
bookToc: true
---

# Как работает гибридный поиск

## Конвейер обработки

Когда вы запускаете `qmd query`, запрос проходит через сложный конвейер:

1. **Расширение запроса** — ИИ генерирует альтернативные формулировки
2. **Параллельный поиск** — каждая формулировка ищет и по словам, и по векторам
3. **RRF-слияние** — результаты объединяются по математической формуле
4. **LLM-ранжирование** — ИИ оценивает релевантность каждого результата
5. **Позиционное смешивание** — финальные оценки комбинируют поиск и ранжирование

## Шаг 1: Расширение запроса

Ваш запрос обрабатывается локальной ИИ-моделью, которая создаёт альтернативные формулировки. Оригинальный запрос получает **двойной вес**.

## Шаг 2: Параллельный поиск

Каждый вариант запроса ищет в обоих индексах (BM25 + вектор) = 6 списков результатов.

## Шаг 3: Reciprocal Rank Fusion (RRF)

```
score = Σ(1 / (k + rank + 1))    где k = 60
```

Документы из нескольких списков получают более высокие оценки. Бонус: #1 → +0.05, #2–3 → +0.02.

## Шаг 4: LLM-ранжирование

Топ-30 кандидатов оцениваются моделью Qwen3 Reranker (от 0 до 10).

## Шаг 5: Позиционное смешивание

| Позиция RRF | Вес поиска | Вес ранжирования |
|-------------|-----------|-----------------|
| 1–3 | 75% | 25% |
| 4–10 | 60% | 40% |
| 11+ | 40% | 60% |

Топовые результаты часто содержат точные совпадения, которые нужно сохранить. Нижние позиции больше выигрывают от оценки ИИ.

## Далее

Изучим MCP HTTP-сервер для общего, постоянно работающего доступа.
