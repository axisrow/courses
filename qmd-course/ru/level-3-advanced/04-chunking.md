---
title: "Алгоритм умной нарезки"
weight: 14
bookToc: true
---

# Алгоритм умной нарезки

## Зачем нужна нарезка?

ИИ-модели лучше работают с короткими фрагментами текста. QMD разбивает документы на куски по ~900 токенов (~700 слов) с 15% перекрытием.

Ключевой вопрос — *где* разрезать. Плохой разрез посреди абзаца теряет смысл.

## Оценки точек разрыва

| Элемент | Оценка | Описание |
|---------|--------|----------|
| `# Заголовок` | 100 | H1 — главный раздел |
| `## Заголовок` | 90 | H2 — подраздел |
| `### Заголовок` | 80 | H3 |
| `#### Заголовок` | 70 | H4 |
| ` ``` ` | 80 | Граница блока кода |
| `---` | 60 | Горизонтальная линия |
| Пустая строка | 20 | Граница абзаца |
| `- элемент` | 5 | Элемент списка |
| Перенос строки | 1 | Минимальный разрыв |

## Алгоритм

1. Сканирование документа для поиска всех точек разрыва
2. При приближении к 900-токенному лимиту — поиск в окне 200 токенов перед границей
3. Оценка: `finalScore = baseScore × (1 - (distance/window)² × 0.7)`
4. Разрез в точке с наивысшей оценкой

## Защита блоков кода

Точки разрыва внутри блоков кода игнорируются. Код остаётся целым.

## Зачем 15% перекрытие?

Перекрытие гарантирует, что информация на границах фрагментов не потеряется.

## Формат эмбеддинга

Каждый фрагмент включает заголовок документа:

```
"title: Архитектура ПО | text: В этом разделе обсуждается..."
```

## Далее

В последнем уроке соберём всё вместе в реальных рабочих процессах.
