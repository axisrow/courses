---
title: "Песочница (Sandbox)"
weight: 3
bookToc: true
---

# Песочница (Sandbox)

## Введение

**Песочница** — это изолированная среда, в которой DeerFlow выполняет код. Это как отдельный компьютер внутри вашего компьютера, где агент может экспериментировать, не рискуя повредить ваши файлы или систему.

## Зачем нужна песочница?

- **Безопасность**: код выполняется в изолированной среде
- **Чистота**: каждая сессия начинается «с чистого листа»
- **Воспроизводимость**: результат не зависит от состояния вашей системы
- **Аудит**: все действия агента записываются и видны вам

## Типы песочниц

### Локальная песочница (Local)

Самый простой вариант. Код выполняется прямо на вашем компьютере, но в изолированных директориях.

```yaml
# config.yaml
sandbox:
  use: src.sandbox.local:LocalSandboxProvider
```

**Плюсы**: быстрая, простая настройка
**Минусы**: меньше изоляции

### Docker-песочница (AioSandbox)

Код выполняется в Docker-контейнере — полностью изолированной среде.

```yaml
# config.yaml
sandbox:
  use: src.community.aio_sandbox:AioSandboxProvider
```

**Плюсы**: полная изоляция, безопасность
**Минусы**: нужен Docker, чуть медленнее

### Kubernetes-песочница

Для продакшн-среды — каждая песочница в отдельном поде Kubernetes.

```yaml
# config.yaml
sandbox:
  use: src.community.aio_sandbox:AioSandboxProvider
  provisioner_url: http://provisioner:8002
```

## Виртуальные пути

Агент видит файловую систему через **виртуальные пути**:

| Виртуальный путь | Физическое расположение | Описание |
|-----------------|------------------------|----------|
| `/mnt/user-data/workspace/` | `threads/{id}/user-data/workspace/` | Рабочая папка |
| `/mnt/user-data/uploads/` | `threads/{id}/user-data/uploads/` | Загруженные файлы |
| `/mnt/user-data/outputs/` | `threads/{id}/user-data/outputs/` | Результаты |
| `/mnt/skills/` | `deer-flow/skills/` | Навыки |

> **Виртуальный путь** — это «обманка» для агента. Он думает, что работает с путём `/mnt/user-data/`, но на самом деле файлы лежат в другом месте. Это нужно для безопасности и переносимости.

## Инструменты песочницы

| Инструмент | Описание | Пример |
|-----------|----------|--------|
| `bash` | Запуск команд | `bash("pip install pandas")` |
| `ls` | Список файлов | `ls("/mnt/user-data/workspace")` |
| `read_file` | Чтение файла | `read_file("/mnt/user-data/workspace/data.csv")` |
| `write_file` | Запись файла | `write_file("/mnt/user-data/outputs/report.md", "...")` |
| `str_replace` | Замена текста | `str_replace("file.py", "old", "new")` |

## Жизненный цикл песочницы

1. **Acquire** (получение): при начале сессии песочница создаётся
2. **Use** (использование): агент работает в песочнице
3. **Release** (освобождение): по окончании сессии ресурсы освобождаются

Это управляется автоматически через **SandboxMiddleware** — компонент, который следит за жизненным циклом.

## Настройка Docker-песочницы

### Подготовка образа

```bash
make setup-sandbox   # Скачать Docker-образ песочницы
```

### Дополнительные монтирования

Если нужно дать агенту доступ к определённым папкам:

```yaml
sandbox:
  use: src.community.aio_sandbox:AioSandboxProvider
  mounts:
    - host_path: /path/on/your/computer
      container_path: /mnt/extra-data
      read_only: true
```

## Практический пример

Попробуйте:

```
Установи библиотеку matplotlib в песочницу,
создай график синусоиды и сохрани как PNG.
Покажи мне результат.
```

DeerFlow выполнит:
1. `bash("pip install matplotlib")` — установка библиотеки
2. `write_file("plot.py", ...)` — создание скрипта
3. `bash("python plot.py")` — запуск
4. `present_files("graph.png")` — показ результата

## Итоги

- Песочница обеспечивает безопасное выполнение кода
- Три типа: локальная, Docker, Kubernetes
- Агент работает с виртуальными путями
- Жизненный цикл управляется автоматически
- Docker-песочница рекомендуется для продакшн-использования
