---
title: "树结构生成的工作原理"
weight: 1
bookToc: true
---

# 树结构生成的工作原理

## 两步流程

PageIndex 的工作分为两个主要阶段：

1. **索引生成** — 从文档构建树结构
2. **树搜索** — 使用树结构查找相关信息

本课重点介绍第一阶段：PageIndex 如何创建树。

## 第一步：检测目录

PageIndex 首先查看文档的前几页（默认前 20 页），检查是否存在目录（TOC）。

系统使用大语言模型分析每一页，回答："这一页是否包含目录？" 如果找到目录，PageIndex 会提取它并作为树的基础。

有三种可能的情况：

| 情况 | PageIndex 的做法 |
|------|-----------------|
| 找到带页码的目录 | 提取目录并映射到实际页面 |
| 找到不带页码的目录 | 提取目录，然后扫描文档查找页码 |
| 没有找到目录 | 通过分析整个文档生成结构 |

## 第二步：页码映射

如果目录包含页码，PageIndex 需要计算**偏移量**——印刷页码与实际 PDF 页码之间的差异。例如，如果目录中"第一章"标注为第 1 页，但实际在 PDF 的第 5 页，偏移量就是 4。

计算方法：
1. 查看目录中前几个章节
2. 扫描文档找到这些章节的实际位置
3. 计算最常见的差值（偏移量）
4. 将偏移量应用到所有目录条目

## 第三步：验证

构建树之后，PageIndex 会验证其准确性：

1. 对于树中的每个章节，检查：该章节标题是否真的出现在分配的页面上？
2. 如果准确率高于 60%，尝试修复错误条目
3. 如果准确率太低，回退到其他策略（如从头生成结构）

## 第四步：处理大节点

如果某个章节覆盖的页数过多（默认超过 10 页）或 token 数过多（超过 20,000），PageIndex 会递归地将其拆分为子章节——在树中创建更深的层级。

## 回退策略

PageIndex 有智能的回退机制：

```
尝试带页码的目录
    ↓（如果准确率 < 60%）
尝试不带页码的目录
    ↓（如果准确率 < 60%）
从头生成结构
```

无论文档质量如何，都能确保可靠的结果。

## 总结

树结构生成是一个智能的多步流程：检测目录、映射页码、验证准确性、处理边界情况。系统会根据发现的内容调整策略，始终追求最准确的树结构。
