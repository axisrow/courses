---
title: "验证与错误修正"
weight: 3
bookToc: true
---

# 验证与错误修正

## 为什么验证很重要

大语言模型可能会犯错。生成的树可能将章节分配到错误的页面。PageIndex 包含一个强大的验证和修正系统来捕获和修复这些错误。

## 验证流程

### 第一步：标题出现检查

对于树中的每个章节，PageIndex 询问大语言模型：*"这个章节标题是否出现在这一页上？"*

使用模糊比较处理格式差异（多余的空格、大小写）。

### 第二步：计算准确率

检查所有（或随机抽样的）章节后：

```
准确率 = 正确数量 / 检查总数
```

### 第三步：决策逻辑

根据准确率，PageIndex 决定下一步：

| 准确率 | 操作 |
|--------|------|
| 100% | 直接接受树 |
| 60-99% | 尝试修复错误条目 |
| 低于 60% | 回退到其他策略 |

## 错误修正流程

### 查找正确的页码

对于每个错误条目，PageIndex：

1. **确定边界** — 找到最近的正确条目（前后各一个）
2. **提取页面范围** — 获取这些页面的文本
3. **询问大语言模型** — "在这段文本中，这个章节从哪里开始？"
4. **验证修复** — 检查新的页码分配是否正确

### 重试逻辑

修正过程最多重试 3 次：

```
第 1 轮：修复所有错误条目
  ↓（检查结果）
第 2 轮：修复剩余错误条目
  ↓（检查结果）
第 3 轮：修复剩余错误条目
  ↓（接受当前结果）
```

每轮都会缩小错误条目的范围。

## 验证保护

### 物理索引验证

验证前，PageIndex 检查所有页码是否合理：
- 页码不能超过文档总长度
- 页码必须是正整数
- 不合理的页码设为 `None`

### 起始位置检查

PageIndex 还检查章节是在指定页面的**开头**还是**中间**开始，处理标题出现在页面上但章节并非从该页开始的边界情况。

## 回退链

如果验证发现树不可靠：

1. **带页码的目录** → 准确率太低 → 回退到：
2. **不带页码的目录** → 准确率太低 → 回退到：
3. **从头生成** → 如果也失败 → 抛出异常

三级回退确保 PageIndex 能处理最困难的文档。

## 总结

PageIndex 的验证系统检查每个章节的页码分配，通过迭代修正流程修复错误，并在需要时回退到替代策略。这种多层方法是实现 98% 以上准确率的关键。
