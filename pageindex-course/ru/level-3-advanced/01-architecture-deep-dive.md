---
title: "Глубокое погружение в архитектуру"
weight: 1
bookToc: true
---

# Глубокое погружение в архитектуру

## Обзор системы

PageIndex состоит из нескольких взаимосвязанных компонентов, которые преобразуют документы в поисковые древовидные структуры.

## Основные модули

### page_index.py — Главный движок

- **Обнаружение TOC** (`find_toc_pages`, `toc_detector_single_page`): Сканирует страницы для поиска оглавления
- **Извлечение TOC** (`toc_extractor`, `extract_toc_content`): Извлекает и очищает содержимое оглавления
- **Трансформация TOC** (`toc_transformer`): Преобразует текст TOC в структурированный JSON
- **Маппинг страниц** (`toc_index_extractor`, `calculate_page_offset`): Сопоставляет логические и физические номера страниц
- **Верификация** (`verify_toc`, `check_title_appearance`): Проверяет точность дерева
- **Исправление ошибок** (`fix_incorrect_toc`): Исправляет неверные привязки страниц
- **Рекурсивная декомпозиция** (`process_large_node_recursively`): Разбивает большие разделы

### utils.py — Утилиты

- Коммуникация с API OpenAI (синхронная и асинхронная)
- Подсчёт токенов
- Извлечение и парсинг JSON
- Постобработка структур
- Извлечение текста из PDF

### config.yaml — Конфигурация по умолчанию

```yaml
model: "gpt-4o-2024-11-20"
toc_check_page_num: 20
max_page_num_each_node: 10
max_token_num_each_node: 20000
```

## Конвейер обработки

```
PDF на входе
  │
  ▼
Извлечение текста и подсчёт токенов
  │
  ▼
Обнаружение TOC
  │
  ├─ TOC с номерами страниц → Извлечение, смещение, верификация
  ├─ TOC без номеров → Извлечение, сканирование, верификация
  └─ Нет TOC → Генерация структуры из всего документа
  │
  ▼
Проверка точности
  │
  ├─ Точность ≥ 60% → Исправление неверных записей
  └─ Точность < 60% → Переход к следующей стратегии
  │
  ▼
Рекурсивная декомпозиция больших узлов
  │
  ▼
Добавление ID, резюме, описаний
  │
  ▼
JSON-дерево на выходе
```

## Модель параллелизма

PageIndex использует `asyncio` с `asyncio.gather` для параллельной обработки:

- Проверки названий выполняются параллельно по всем узлам
- Исправление ошибок обрабатывает несколько записей одновременно
- Декомпозиция больших узлов идёт параллельно для узлов-соседей

## Паттерн мета-процессора

Функция `meta_processor` реализует стратегию с автоматическим откатом:

1. Сначала попробовать самую информативную стратегию
2. При низкой точности — перейти к следующей
3. Продолжать до успеха или исчерпания вариантов

## Итоги

Архитектура PageIndex — это конвейер обнаружения, извлечения, маппинга, верификации и исправления с интеллектуальными откатами и параллельной обработкой.
